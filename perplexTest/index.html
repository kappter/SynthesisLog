<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Roget Amalgamations</title>
  <style>
  .circle {
    position: relative;
    width: 420px;
    height: 420px;
    margin: 1rem auto;
    border-radius: 50%;
    border: 2px solid #ccc;
  }
  .stage {
    position: absolute;
    width: 40%;
  }
  .stage h3 { margin: 0 0 0.25rem; font-size: 0.9rem; }
  .stage textarea { width: 100%; min-height: 80px; }
  /* positions: 12, 3, 6, 9 o'clock */
  #stage1 { top: 0; left: 30%; transform: translateY(-10%); }
  #stage2 { top: 30%; right: 0; transform: translateX(10%); }
  #stage3 { bottom: 0; left: 30%; transform: translateY(10%); }
  #stage4 { top: 30%; left: 0; transform: translateX(-10%); }
  .controls { text-align: center; margin-top: 1rem; }
</style>

<div class="circle">
  <!-- 12 o'clock: Day 1 – History -->
  <div class="stage stage-top">
    <div class="stage-label">1 · History</div>
    <div class="stage-term">[new term]</div>
    <textarea placeholder="Historical notes..."></textarea>
  </div>

  <!-- 3 o'clock: Day 2 – Concrete/Abstract -->
  <div class="stage stage-right">
    <div class="stage-label">2 · Concrete / Abstract</div>
    <div class="stage-term">[term from yesterday]</div>
    <textarea placeholder="Concrete/abstract images..."></textarea>
  </div>

  <!-- 6 o'clock: Day 3 – Amalgamation -->
  <div class="stage stage-bottom">
    <div class="stage-label">3 · Amalgamation</div>
    <div class="stage-term">[term from two days ago]</div>
    <textarea placeholder="Amalgamations with the other three terms..."></textarea>
  </div>

  <!-- 9 o'clock: Day 4 – Motion -->
  <div class="stage stage-left">
    <div class="stage-label">4 · Motion</div>
    <div class="stage-term">[oldest term in queue]</div>
    <textarea placeholder="Name the motion / proposal..."></textarea>
  </div>

  <!-- optional small center label showing today’s 4-term set -->
  <div class="center-label">
    <div>Today’s set:</div>
    <div>[T1 · T2 · T3 · T4]</div>
  </div>
</div>


  <script>
  let snapshot = null;

  function init() {
    google.script.run
      .withSuccessHandler(drawCircle)
      .withFailureHandler(showError)
      .getState();
  }

  function drawCircle(data) {
    snapshot = data;
    const last4 = data.last4; // oldest first

    const stages = [
      { el: 'stage1', col: 'History', label: 'Day 1 – History' },
      { el: 'stage2', col: 'ConcreteAbstract', label: 'Day 2 – Concrete/Abstract' },
      { el: 'stage3', col: 'Amalgamation', label: 'Day 3 – Amalgamation' },
      { el: 'stage4', col: 'Motion', label: 'Day 4 – Motion' }
    ];

    stages.forEach((stage, i) => {
      const row = last4[i] || {};
      const term = row.Term || '(empty)';
      const text = row[stage.col] || '';
      const div = document.getElementById(stage.el);
      div.innerHTML =
        '<h3>' + stage.label + '<br>' + term + '</h3>' +
        '<textarea data-row-index="' + (snapshot.rows.length - last4.length + i) +
        '" data-col="' + stage.col + '">' +
        text + '</textarea>';
    });

    document.getElementById('status').textContent = '';
  }

  function saveAll() {
    const boxes = document.querySelectorAll('.stage textarea');
    document.getElementById('status').textContent = 'Saving...';

    const ops = [];
    boxes.forEach(box => {
      const rowIndex = parseInt(box.dataset.rowIndex, 10);
      const col = box.dataset.col;
      const val = box.value;
      ops.push(new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .saveAnswer(rowIndex, col, val);
      }));
    });

    Promise.all(ops)
      .then(() => document.getElementById('status').textContent = 'Saved.')
      .catch(err => showError(err));
  }

  function advance() {
    document.getElementById('status').textContent = 'Advancing...';
    google.script.run
      .withSuccessHandler(drawCircle)
      .withFailureHandler(showError)
      .advanceDay();
  }

  function showError(err) {
    document.getElementById('status').textContent = 'Error: ' + err.message;
  }

  window.onload = init;
</script>

</body>
</html>
