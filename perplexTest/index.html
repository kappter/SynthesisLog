<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Roget Amalgamations</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 1rem; }
    .term-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
    .term-card { border: 1px solid #ccc; padding: 0.5rem; border-radius: 4px; }
    .term-card h3 { margin: 0 0 0.25rem; font-size: 0.9rem; }
    textarea { width: 100%; min-height: 120px; }
    .question-label { font-weight: 600; margin-bottom: 0.25rem; }
    button { margin-top: 0.5rem; padding: 0.4rem 0.8rem; }
    .status { margin-top: 0.5rem; font-size: 0.85rem; color: #555; }
  </style>
</head>
<body>
  <h1>Roget Amalgamations</h1>

  <div id="termWindow" class="term-grid"></div>

  <div id="questionBlock">
    <div class="question-label" id="questionLabel"></div>
    <div id="questionPrompt"></div>
    <textarea id="answerBox" placeholder="Type today&#39;s response..."></textarea>
    <button onclick="saveToday()">Save</button>
    <div class="status" id="status"></div>
  </div>

  <script>
    let state = null;

    const QUESTION_COLUMNS = ['History','ConcreteAbstract','Amalgamation','Motion'];

    const QUESTION_TEXT = {
      History: 'Day 1 – historical context and background for the focal term.',
      ConcreteAbstract: 'Day 2 – concrete / abstract applications or images involving the focal term.',
      Amalgamation: 'Day 3 – amalgamations among the four current terms, keeping the focal term centered.',
      Motion: 'Day 4 – name a motion or connection that links the four terms, anchored in the focal term.'
    };

    function init() {
      google.script.run
        .withSuccessHandler(buildUI)
        .withFailureHandler(err => {
          document.getElementById('status').textContent = 'Error: ' + err.message;
        })
        .getDailyData();
    }

    function buildUI(data) {
      state = data;
      const { rows, todayIndex } = data;
      const termDiv = document.getElementById('termWindow');
      termDiv.innerHTML = '';

      if (todayIndex === -1) {
        termDiv.textContent = 'No row found for today.';
        document.getElementById('questionBlock').style.display = 'none';
        return;
      }

      // Build 4‑day window centered on todayIndex (today is last day for its term)
      const windowRows = [];
      for (let offset = -3; offset <= 0; offset++) {
        const idx = todayIndex + offset;
        if (idx >= 0 && idx < rows.length) windowRows.push({ idx, row: rows[idx] });
      }

      windowRows.forEach(({ idx, row }) => {
        const card = document.createElement('div');
        card.className = 'term-card';
        card.innerHTML =
          '<h3>' + (row.Term || '(no term)') + '</h3>' +
          '<div>History: ' + (row.History || '') + '</div>' +
          '<div>Concrete/Abstract: ' + (row.ConcreteAbstract || '') + '</div>' +
          '<div>Amalgamation: ' + (row.Amalgamation || '') + '</div>' +
          '<div>Motion: ' + (row.Motion || '') + '</div>';
        termDiv.appendChild(card);
      });

      // Decide which question is active for today’s term
      const todayRow = rows[todayIndex];
      const answeredCount = QUESTION_COLUMNS
        .map(col => todayRow[col])
        .filter(v => v && v !== '').length;

      const colKey = QUESTION_COLUMNS[Math.min(answeredCount, QUESTION_COLUMNS.length - 1)];
      state.activeColKey = colKey;
      state.todayIndex = todayIndex;

      document.getElementById('questionLabel').textContent =
        todayRow.Term + ' — ' + colKey;
      document.getElementById('questionPrompt').textContent =
        QUESTION_TEXT[colKey];
      document.getElementById('answerBox').value = todayRow[colKey] || '';
      document.getElementById('status').textContent = '';
    }

    function saveToday() {
      if (!state) return;
      const text = document.getElementById('answerBox').value;
      document.getElementById('status').textContent = 'Saving...';

      google.script.run
        .withSuccessHandler(() => {
          document.getElementById('status').textContent = 'Saved.';
        })
        .withFailureHandler(err => {
          document.getElementById('status').textContent = 'Error: ' + err.message;
        })
        .saveAnswer(state.todayIndex, state.activeColKey, text);
    }

    window.onload = init;
  </script>
</body>
</html>
