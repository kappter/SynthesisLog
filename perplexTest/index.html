<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Roget Amalgamations</title>
  <style>
  .circle {
    position: relative;
    width: 420px;
    height: 420px;
    margin: 1rem auto;
    border-radius: 50%;
    border: 2px solid #ccc;
  }
  .stage {
    position: absolute;
    width: 40%;
  }
  .stage h3 { margin: 0 0 0.25rem; font-size: 0.9rem; }
  .stage textarea { width: 100%; min-height: 80px; }
  /* positions: 12, 3, 6, 9 o'clock */
  #stage1 { top: 0; left: 30%; transform: translateY(-10%); }
  #stage2 { top: 30%; right: 0; transform: translateX(10%); }
  #stage3 { bottom: 0; left: 30%; transform: translateY(10%); }
  #stage4 { top: 30%; left: 0; transform: translateX(-10%); }
  .controls { text-align: center; margin-top: 1rem; }
</style>

<div class="circle">
  <div class="stage" id="stage1"></div>
  <div class="stage" id="stage2"></div>
  <div class="stage" id="stage3"></div>
  <div class="stage" id="stage4"></div>
</div>

<div class="controls">
  <button onclick="saveAll()">Save today</button>
  <button onclick="advance()">Next day</button>
  <div id="status"></div>
</div>

</head>
<body>
  <h1>Roget Amalgamations</h1>

  <div id="termWindow" class="term-grid"></div>

  <div id="questionBlock">
    <div class="question-label" id="questionLabel"></div>
    <div id="questionPrompt"></div>
    <textarea id="answerBox" placeholder="Type today&#39;s response..."></textarea>
    <button onclick="saveToday()">Save</button>
    <div class="status" id="status"></div>
  </div>

  <script>
  let snapshot = null;

  function init() {
    google.script.run
      .withSuccessHandler(drawCircle)
      .withFailureHandler(showError)
      .getState();
  }

  function drawCircle(data) {
    snapshot = data;
    const last4 = data.last4; // oldest first

    const stages = [
      { el: 'stage1', col: 'History', label: 'Day 1 – History' },
      { el: 'stage2', col: 'ConcreteAbstract', label: 'Day 2 – Concrete/Abstract' },
      { el: 'stage3', col: 'Amalgamation', label: 'Day 3 – Amalgamation' },
      { el: 'stage4', col: 'Motion', label: 'Day 4 – Motion' }
    ];

    stages.forEach((stage, i) => {
      const row = last4[i] || {};
      const term = row.Term || '(empty)';
      const text = row[stage.col] || '';
      const div = document.getElementById(stage.el);
      div.innerHTML =
        '<h3>' + stage.label + '<br>' + term + '</h3>' +
        '<textarea data-row-index="' + (snapshot.rows.length - last4.length + i) +
        '" data-col="' + stage.col + '">' +
        text + '</textarea>';
    });

    document.getElementById('status').textContent = '';
  }

  function saveAll() {
    const boxes = document.querySelectorAll('.stage textarea');
    document.getElementById('status').textContent = 'Saving...';

    const ops = [];
    boxes.forEach(box => {
      const rowIndex = parseInt(box.dataset.rowIndex, 10);
      const col = box.dataset.col;
      const val = box.value;
      ops.push(new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .saveAnswer(rowIndex, col, val);
      }));
    });

    Promise.all(ops)
      .then(() => document.getElementById('status').textContent = 'Saved.')
      .catch(err => showError(err));
  }

  function advance() {
    document.getElementById('status').textContent = 'Advancing...';
    google.script.run
      .withSuccessHandler(drawCircle)
      .withFailureHandler(showError)
      .advanceDay();
  }

  function showError(err) {
    document.getElementById('status').textContent = 'Error: ' + err.message;
  }

  window.onload = init;
</script>

</body>
</html>
